!function(e){function t(e="#switcheroo",t={}){this.selector=e;var o={logo:"",confirm:!0,explore:!0,profile:!0,formAutocomplete:"off",blockClass:"switcheroo",exploreIcon:'more',deleteIcon:'Ã—',addIcon:'+',errorMsg:"Une erreur est surviendue lors du Switcheroo.",confirmMsg:"Confirmer le Switcheroo de personnage ?",modal:{},buttons:[]};this.options=arguments[1]&&"object"==typeof arguments[1]?Object.assign({},o,t):o,this.createFormModal(this.options.modal),this.elements={loginButton:document.querySelector('[data-action="open-login"]'),loginFormID:"fa-login-form",classPrefix:"."+this.options.blockClass,deleteButtonClass:"."+this.options.blockClass+"__delete",logoutLink:document.querySelector("#logout")||null},localStorage.hasOwnProperty("switcheroo")||localStorage.setItem("switcheroo","[]"),this.buildSwitcheroo(),this.bindEvents()}e.monomer=e.monomer||new MONOMER,t.prototype.bindEvents=function(){let e=this;document.delegateEventListener("click",'[data-action="open-login"]',(e=>{this.loginModal.open()})),document.delegateEventListener("click",'[data-action="switcheroo"]',(function(t){e.isCloseButton(t)&&e.deleteRecord(this.dataset.id)})),document.delegateEventListener("click",'[data-action="switcheroo"]:not(.active)',(function(t){e.isCloseButton(t)||(e.options.confirm?1==confirm(e.options.confirmMsg)&&e.switch(this):e.switch(this))}))},t.prototype.add=function(e){let t=(({username:e,password:t})=>({username:e,password:monomer.cipher(t)}))(monomer.getFormData(e));monomer.user().logged()?this.logout((()=>{this.login(t,(e=>{t=Object.assign({},t,this.updateCredentials(e)),this.update(t),monomer.reload()}),(()=>{this.errorAlert()}))})):this.login(t,(e=>{t=Object.assign({},t,this.updateCredentials(e)),this.update(t),monomer.reload()}),(()=>{this.errorAlert()}))},t.prototype.switch=function(e){let t=e.dataset.id,o=this.findSwitcheroo(t);monomer.user().logged()?o&&this.logout((()=>{this.login(o,monomer.reload,(()=>{this.errorAlert()}))})):o&&this.login(o,monomer.reload,(()=>{this.errorAlert()}))},t.prototype.login=function(e,t,o){monomer.login(e.username,monomer.decipher(e.password)).then((e=>{this.statusCallbacks(e,t,o)}))},t.prototype.logout=function(e,t){monomer.logout().then((o=>{this.statusCallbacks(o,e,t)}))},t.prototype.statusCallbacks=function(e,t,o){e.status?t&&t(e.data):o&&o(e.data)},t.prototype.errorAlert=function(){alert(this.options.errorMsg)},t.prototype.update=function(e){this.credentialsExists(e.id)||(this.switcherooCredentials.push(e),this.updateStorage())},t.prototype.findSwitcheroo=function(e){return this.switcherooCredentials.find((t=>t.id===e))},t.prototype.deleteSwitcheroo=function(e){this.switcherooCredentials=this.switcherooCredentials.filter((function(t){return t.id!==e}))},t.prototype.updateCredentials=function(e){return{id:this.catchID(e),avatar:this.catchAvatar(e),username:this.catchUsername(e)}},t.prototype.credentialsExists=function(e){return this.switcherooCredentials.some((function(t){return t.id===e}))},t.prototype.deleteRecord=function(e){this.deleteSwitcheroo(e),this.updateStorage(),monomer.reload()},t.prototype.updateStorage=function(){localStorage.setItem("switcheroo",JSON.stringify(this.switcherooCredentials))},t.prototype.isCloseButton=function(e){return e.target.matches(this.elements.deleteButtonClass)},t.prototype.catchAvatar=function(e){return new RegExp(/_userdata\["avatar"\] = "(.+)";/,"gm").exec(e)[1]},t.prototype.catchID=function(e){return new RegExp(/_userdata\["user_id"\] = (\d+);/,"gm").exec(e)[1]},t.prototype.catchUsername=function(e){return new RegExp(/_userdata\["username"\] = "(.+)";/,"gm").exec(e)[1]},t.prototype.buildSwitcheroo=function(){var e=this.options.blockClass;this.switcherooCredentials=JSON.parse(localStorage.getItem("switcheroo"));let t=document.createDocumentFragment(),o=document.createElement("ul");o.classList.add(e+"__squircles");const i=document.createElement("li");if(i.classList.add(e+"__divider"),this.options.logo){let t=document.createElement("a");t.classList.add(e+"__squircle",e+"__logo"),t.href="/",t.innerHTML=this.options.logo,t.appendChild(this.createTooltip("Accueil")),o.appendChild(t),o.appendChild(i)}this.buildPersonas(o);const s=document.createElement("li");if(s.classList.add(e+"__squircle",e+"__squircle--button"),s.dataset.action="open-login",s.innerHTML=this.options.addIcon,s.appendChild(this.createTooltip("Associer un personnage")),o.appendChild(s),this.options.explore){const t=document.createElement("a");t.classList.add(e+"__squircle",e+"__squircle--button"),t.href="/memberlist",t.innerHTML=this.options.exploreIcon,t.appendChild(this.createTooltip("Explorer les personnages")),o.appendChild(t)}this.options.buttons.length>0&&this.buildButtons(o),t.appendChild(o),document.querySelector(this.selector).appendChild(t)},t.prototype.buildPersonas=function(e){var t=this.options.blockClass;this.switcherooCredentials.forEach((o=>{let i=o.id==monomer.user().id(),s=document.createElement("li");s.classList.add(t+"__squircle"),s.dataset.action="switcheroo",s.dataset.id=o.id;let n=document.createElement("div");if(n.classList.add(t+"__avatar"),n.innerHTML=o.avatar.replace(/\\"/g,'"'),i)if(s.classList.add("active"),this.options.profile){let e=document.createElement("a");e.classList.add(t+"__link"),e.href="/profile?mode=editprofile",e.appendChild(n),s.appendChild(e)}else link.appendChild(n);else s.appendChild(n);s.appendChild(this.createTooltip(o.username));let r=document.createElement("div");r.classList.add(t+"__delete"),r.innerHTML=this.options.deleteIcon,s.appendChild(r),e.appendChild(s)}))},t.prototype.buildButtons=function(e){this.options.blockClass;this.options.buttons.forEach(((t,o)=>{let i=this.createPresetButton(t,o);monomer.is(i,"element")&&e.appendChild(i)}))},t.prototype.createPresetButton=function(e,t){let o=this.options.blockClass,i=document.createElement("li");switch(i.classList.add(o+"__squircle",o+"__squircle--button",o+"__squircle--"+t),e){case"logout":if(!monomer.user().logged())return"";i.classList.add(o+"__squircle--logout"),i.innerHTML='<a href="'+this.elements.logoutLink.href+'" class="'+o+"__link "+o+"__squircle--cb"+t+'"><i class="material-icons">power_settings_new</i>';break;default:return!1}return i},t.prototype.createTooltip=function(e){let t=this.options.blockClass,o=document.createElement("div");o.classList.add(t+"__popper");let i=document.createElement("div");return i.classList.add(t+"__popper-text"),i.innerHTML=e,o.appendChild(i),o},t.prototype.createFormModal=function(e){const t=document.createDocumentFragment(),o="switcheroo",i=VD.h("form",{className:o+"__form",name:"form_login",method:"post",action:"/login",autocomplete:this.options.formAutocomplete,onSubmit:e=>{e.preventDefault(),this.add(e.target)}},VD.h("div",{className:o+"__form-row"},VD.h("label",{for:o+"-username",className:o+"__form-label"},"Nom d'utilisateur"),VD.h("input",{type:"text",className:o+"__form-input",id:o+"-username",name:"username",required:!0,maxlength:"40",autocomplete:this.options.formAutocomplete})),VD.h("div",{className:o+"__form-row"},VD.h("label",{for:o+"-password",className:o+"__form-label"},"Mot de passe"),VD.h("input",{className:o+"__form-input",type:"password",id:o+"-password",name:"password",required:!0,maxlength:"32",autocomplete:this.options.formAutocomplete})),VD.h("input",{type:"checkbox",style:"display: none;",name:"autologin",checked:!0}),VD.h("div",{className:o+"__form-row"},VD.h("button",{name:"login",className:o+"__form-button"},"Connexion")));t.appendChild(VD.createElement(i)),this.loginModal=monomer.modal({content:VD.createElement(i),maxWidth:400})},e.Switcheroo=t}(window);
